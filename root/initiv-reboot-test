#!/bin/bash
# Simplified reboot test script - tests reboot mechanism 50 times
# Author: Claude Code for testing Stage 1 reboot issue
set -euo pipefail
PROJECT="busybox-reboot-test"
_USER="busybox"
_USER_HOME="/home/$_USER"
_LOGFILE=${_USER_HOME}/${PROJECT}.log
_COUNTER_FILE="${_USER_HOME}/reboot-test-count"
_MAX_ITERATIONS=2
. /usr/bin/bashcolors 2>/dev/null || true  # Load bash colors

echoinfo() {  # Log info message
    echo -e "\e[32m[INFO]\e[0m $*" | tee -a $_LOGFILE
}
echoerror() {  # Log error message
    echo -e "\e[31m[ERROR]\e[0m $*" | tee -a $_LOGFILE
}
echosuccess() {  # Log success message
    echo -e "\e[32m[SUCCESS]\e[0m $*" | tee -a $_LOGFILE
}

install_sudo() {  # Install sudo package if not present
    if ! command -v sudo &> /dev/null; then
        echoinfo "Installing sudo package..."
        apt-get update -qq
        apt-get install -y -qq sudo
        echosuccess "sudo installed successfully"
    else
        echoinfo "sudo already installed"
    fi
}

create_test_user() {  # Create busybox user with sudo privileges
    echoinfo "Creating user: $_USER"
    /usr/sbin/groupadd $_USER 2>/dev/null || echoinfo "Group $_USER already exists"  # Create group
    /usr/sbin/useradd -r -s /bin/bash -m -g $_USER $_USER 2>/dev/null || echoinfo "User $_USER already exists"  # Create user
    /usr/sbin/usermod -a -G "sudo" $_USER  # Add to sudo group
    echo "$_USER	ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers 2>/dev/null || true  # Grant sudo without password
    _CAF="/etc/cron.allow"
    if ! grep -q $_USER $_CAF 2>/dev/null; then
        echo "$_USER" >> $_CAF  # Add to cron.allow
    fi
    mkdir -p $_USER_HOME/.ssh  # Create SSH directory
    if [ -f /root/.ssh/authorized_keys ]; then  # Copy SSH keys from root
        cp /root/.ssh/authorized_keys $_USER_HOME/.ssh/
        chown -R $_USER:$_USER $_USER_HOME/.ssh
        chmod 700 $_USER_HOME/.ssh
        chmod 600 $_USER_HOME/.ssh/authorized_keys
        echoinfo "SSH keys copied from root"
    fi
    echosuccess "User $_USER created successfully"
}

setup_autologin() {  # Configure getty autologin for busybox user on tty1
    echoinfo "Setting up autologin for $_USER on tty1"
    rm -rf /etc/systemd/system/getty@tty1.service.d 2>/dev/null  # Remove old config
    mkdir -pv /etc/systemd/system/getty@tty1.service.d
    cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $_USER --noclear %I \$TERM
EOF
    rm -rf /etc/systemd/system/getty@tty2.service.d 2>/dev/null  # Configure tty2 for root
    mkdir -pv /etc/systemd/system/getty@tty2.service.d
    cat > /etc/systemd/system/getty@tty2.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin root --noclear %I \$TERM
EOF
    systemctl daemon-reload  # Reload systemd
    echosuccess "Autologin configured for $_USER"
}

setup_autostart_with_reboot() {  # Create .profile with reboot test countdown
    echoinfo "Setting up autostart script with reboot countdown"
    cat > /home/$_USER/.profile << 'EOFPROFILE'  # Create user .profile
#!/bin/bash
[[ $(tty) != /dev/tty1 ]] && exit 0  # Only run on tty1
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"  # Ensure sudo in PATH
COUNTER_FILE="/home/busybox/reboot-test-count"
LOG_FILE="/home/busybox/busybox-reboot-test.log"
MAX_ITERATIONS=2
COUNTDOWN=30
if [ ! -f "$COUNTER_FILE" ]; then  # Initialize counter if not exists
    echo "1" > "$COUNTER_FILE"
fi
CURRENT_COUNT=$(cat "$COUNTER_FILE")
if [ "$CURRENT_COUNT" -gt "$MAX_ITERATIONS" ]; then  # Check if test completed
    clear
    echo "========================================"
    echo "  REBOOT TEST COMPLETED!"
    echo "========================================"
    echo ""
    echo "Completed $MAX_ITERATIONS successful reboots"
    echo ""
    echo "Test results logged to $LOG_FILE"
    echo ""
    echo "========================================"
    exit 0
fi
clear  # Display current iteration
echo "========================================"
echo "  BUSYBOX REBOOT TEST"
echo "========================================"
echo ""
echo "Iteration: $CURRENT_COUNT / $MAX_ITERATIONS"
echo ""
echo "Testing reboot mechanism from line 2524:"
echo "sudo nohup systemd-run --on-active=5s ..."
echo ""
echo "Countdown to reboot:"
for i in $(seq $COUNTDOWN -1 1); do  # Countdown loop
    printf "\r  Rebooting in %2d seconds... " $i
    sleep 1
done
echo ""
echo ""
echo "Incrementing counter and triggering reboot..."
NEXT_COUNT=$((CURRENT_COUNT + 1))  # Increment counter
echo "$NEXT_COUNT" > "$COUNTER_FILE"
echo "$(date '+%Y-%m-%d %H:%M:%S') - Iteration $CURRENT_COUNT: Executing reboot" >> "$LOG_FILE"  # Log the reboot
sudo nohup systemd-run --on-active=5s --timer-property=AccuracySec=100ms /usr/bin/sudo /sbin/shutdown -r now "Reboot test iteration $CURRENT_COUNT" &  # Execute reboot (EXACT line 2524 method)
sleep 10  # Wait to ensure reboot command is processed
EOFPROFILE
    chown $_USER:$_USER /home/$_USER/.profile  # Set ownership
    chmod +x /home/$_USER/.profile  # Make executable
    echosuccess "Autostart script configured"
}

initialize_test() {  # Reset counter and create log file
    echoinfo "Initializing reboot test"
    echo "1" > $_COUNTER_FILE  # Reset counter to 1
    chown $_USER:$_USER $_COUNTER_FILE  # Set ownership to busybox user
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Reboot test initialized" > $_LOGFILE  # Create log
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Target: $_MAX_ITERATIONS iterations" >> $_LOGFILE
    chown $_USER:$_USER $_LOGFILE  # Set ownership to busybox user
    echosuccess "Test initialized - counter set to 1"
}

main() {  # Main setup execution
    mkdir -p $_USER_HOME  # Create user home directory first
    echo "========================================" | tee -a $_LOGFILE
    echo "  BUSYBOX REBOOT TEST SETUP" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echoinfo "Starting reboot test setup..."
    install_sudo  # Step 1: Install sudo package
    create_test_user  # Step 2: Create user and add to sudoers
    setup_autologin  # Step 3: Setup autologin
    setup_autostart_with_reboot  # Step 4: Setup autostart with reboot
    initialize_test  # Step 5: Initialize test
    echo "" | tee -a $_LOGFILE
    echosuccess "Setup complete!"
    echo "" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "  READY TO START TEST" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "  Test will run automatically on next reboot" | tee -a $_LOGFILE
    echo "  User 'busybox' will auto-login on tty1" | tee -a $_LOGFILE
    echo "  Reboot countdown: 30 seconds" | tee -a $_LOGFILE
    echo "  Total iterations: $_MAX_ITERATIONS" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "  Type 'reboot' to start the test" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
}
main  # Run main function
