#!/bin/bash
# Simplified reboot test script - tests reboot mechanism 50 times
# Author: Claude Code for testing Stage 1 reboot issue
set -euo pipefail
PROJECT="busybox-reboot-test"
_LOGFILE=/var/log/${PROJECT}.log
_USER="busybox"
_COUNTER_FILE="/var/reboot-test-count"
_MAX_ITERATIONS=50
. /usr/bin/bashcolors 2>/dev/null || true  # Load bash colors

echoinfo() {  # Log info message
    echo -e "\e[32m[INFO]\e[0m $*" | tee -a $_LOGFILE
}
echoerror() {  # Log error message
    echo -e "\e[31m[ERROR]\e[0m $*" | tee -a $_LOGFILE
}
echosuccess() {  # Log success message
    echo -e "\e[32m[SUCCESS]\e[0m $*" | tee -a $_LOGFILE
}

create_test_user() {  # Create busybox user with sudo privileges
    echoinfo "Creating user: $_USER"
    /usr/sbin/groupadd $_USER 2>/dev/null || echoinfo "Group $_USER already exists"  # Create group
    /usr/sbin/useradd -r -s /bin/bash -m -g $_USER $_USER 2>/dev/null || echoinfo "User $_USER already exists"  # Create user
    /usr/sbin/usermod -a -G "sudo" $_USER  # Add to sudo group
    echo "$_USER	ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers 2>/dev/null || true  # Grant sudo without password
    _CAF="/etc/cron.allow"
    if ! grep -q $_USER $_CAF 2>/dev/null; then
        echo "$_USER" >> $_CAF  # Add to cron.allow
    fi
    echosuccess "User $_USER created successfully"
}

setup_autologin() {  # Configure getty autologin for busybox user on tty1
    echoinfo "Setting up autologin for $_USER on tty1"
    rm -rf /etc/systemd/system/getty@tty1.service.d 2>/dev/null  # Remove old config
    mkdir -pv /etc/systemd/system/getty@tty1.service.d
    cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $_USER --noclear %I \$TERM
EOF
    rm -rf /etc/systemd/system/getty@tty2.service.d 2>/dev/null  # Configure tty2 for root
    mkdir -pv /etc/systemd/system/getty@tty2.service.d
    cat > /etc/systemd/system/getty@tty2.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin root --noclear %I \$TERM
EOF
    systemctl daemon-reload  # Reload systemd
    echosuccess "Autologin configured for $_USER"
}

setup_autostart_with_reboot() {  # Create .profile with reboot test countdown
    echoinfo "Setting up autostart script with reboot countdown"
    cat > /home/$_USER/.profile << 'EOFPROFILE'  # Create user .profile
#!/bin/bash
[[ $(tty) != /dev/tty1 ]] && exit 0  # Only run on tty1
COUNTER_FILE="/var/reboot-test-count"
MAX_ITERATIONS=50
COUNTDOWN=30
if [ ! -f "$COUNTER_FILE" ]; then  # Initialize counter if not exists
    echo "1" > "$COUNTER_FILE"
fi
CURRENT_COUNT=$(cat "$COUNTER_FILE")
if [ "$CURRENT_COUNT" -gt "$MAX_ITERATIONS" ]; then  # Check if test completed
    clear
    echo "========================================"
    echo "  REBOOT TEST COMPLETED!"
    echo "========================================"
    echo ""
    echo "Completed $MAX_ITERATIONS successful reboots"
    echo ""
    echo "Test results logged to /var/log/busybox-reboot-test.log"
    echo ""
    echo "========================================"
    exit 0
fi
clear  # Display current iteration
echo "========================================"
echo "  BUSYBOX REBOOT TEST"
echo "========================================"
echo ""
echo "Iteration: $CURRENT_COUNT / $MAX_ITERATIONS"
echo ""
echo "Testing reboot mechanism from line 2524:"
echo "sudo nohup systemd-run --on-active=5s ..."
echo ""
echo "Countdown to reboot:"
for i in $(seq $COUNTDOWN -1 1); do  # Countdown loop
    printf "\r  Rebooting in %2d seconds... " $i
    sleep 1
done
echo ""
echo ""
echo "Incrementing counter and triggering reboot..."
NEXT_COUNT=$((CURRENT_COUNT + 1))  # Increment counter
echo "$NEXT_COUNT" > "$COUNTER_FILE"
echo "$(date '+%Y-%m-%d %H:%M:%S') - Iteration $CURRENT_COUNT: Executing reboot" >> /var/log/busybox-reboot-test.log  # Log the reboot
sudo nohup systemd-run --on-active=5s --timer-property=AccuracySec=100ms /usr/bin/sudo /sbin/shutdown -r now "Reboot test iteration $CURRENT_COUNT" &  # Execute reboot (EXACT line 2524 method)
sleep 10  # Wait to ensure reboot command is processed
EOFPROFILE
    chown $_USER:$_USER /home/$_USER/.profile  # Set ownership
    chmod +x /home/$_USER/.profile  # Make executable
    echosuccess "Autostart script configured"
}

initialize_test() {  # Reset counter and create log file
    echoinfo "Initializing reboot test"
    echo "1" > $_COUNTER_FILE  # Reset counter to 1
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Reboot test initialized" > /var/log/busybox-reboot-test.log  # Create log
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Target: $MAX_ITERATIONS iterations" >> /var/log/busybox-reboot-test.log
    echosuccess "Test initialized - counter set to 1"
}

main() {  # Main setup execution
    echo "========================================" | tee -a $_LOGFILE
    echo "  BUSYBOX REBOOT TEST SETUP" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echoinfo "Starting reboot test setup..."
    create_test_user  # Step 1: Create user
    setup_autologin  # Step 2: Setup autologin
    setup_autostart_with_reboot  # Step 3: Setup autostart with reboot
    initialize_test  # Step 4: Initialize test
    echo "" | tee -a $_LOGFILE
    echosuccess "Setup complete!"
    echo "" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "  READY TO START TEST" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "  Test will run automatically on next reboot" | tee -a $_LOGFILE
    echo "  User 'busybox' will auto-login on tty1" | tee -a $_LOGFILE
    echo "  Reboot countdown: 30 seconds" | tee -a $_LOGFILE
    echo "  Total iterations: $MAX_ITERATIONS" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "  Type 'reboot' to start the test" | tee -a $_LOGFILE
    echo "" | tee -a $_LOGFILE
    echo "========================================" | tee -a $_LOGFILE
}
main  # Run main function
